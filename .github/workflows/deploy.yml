name: Deploy

on:
  push:
    paths-ignore:
      - '.github/workflows/**'
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  DEPLOY_PATH: /var/www/pixinvent
  USER_FOLDER_OWNER: www-data

jobs:
  deploy:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH key
        run: |
          echo -e "${{ secrets.PIXINVENT_KEY_DEV }}" > key
          chmod 600 key

      - name: Deploy code to server
        run: |
          rsync -avz --delete -e "ssh -i key -o StrictHostKeyChecking=no" ./ root@109.172.114.179:${{ env.DEPLOY_PATH }}

      - name: Execute remote commands
        run: |
          ssh -i key -o StrictHostKeyChecking=no root@109.172.114.179 << 'EOF'
            echo "Current user: $(whoami)"
            echo "Current directory: $(pwd)"
            chown -R ${{ env.USER_FOLDER_OWNER }}:www-data ${{ env.DEPLOY_PATH }}
            cd ${{ env.DEPLOY_PATH }} || exit 1
            su ${{ env.USER_FOLDER_OWNER }}
            echo "Current user: $(whoami)"
            echo "Current directory: $(pwd)"
            git config --global --add safe.directory ${{ env.DEPLOY_PATH }}
            git pull
            chown -R ${{ env.USER_FOLDER_OWNER }}:www-data storage bootstrap/cache
            chgrp -R www-data storage bootstrap/cache
            chmod -R ug+rwx storage bootstrap/cache
            cp ../.env .env
            composer update --ignore-platform-req=ext-bcmath
            echo $(which bun)
            export BUN_INSTALL="$HOME/.bun"
            export PATH="$BUN_INSTALL/bin:$PATH"
          EOF

      - name: Cleanup temporary files
        if: always()
        run: |
          rm key
