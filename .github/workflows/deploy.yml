name: Deploy

on:
  push:
    paths-ignore:
      - '.github/workflows/**'
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  DEPLOY_USER: root
  DEPLOY_SERVER_IP: 109.172.114.179
  DEPLOY_PATH: /var/www/pixinvent
  USER_FOLDER_OWNER: www-data
  ENV_LOCATION: ~/.env

jobs:
  deploy:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH key
        run: |
          echo -e "${{ secrets.PIXINVENT_KEY_DEV }}" > key
          chmod 600 key

      - name: Deploy code to server
        run: |
         rsync -avz --delete -e "ssh -i key -o StrictHostKeyChecking=no" ./  ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_SERVER_IP }}:${{ env.DEPLOY_PATH }}

      - name: Execute remote commands
        run: |
          ssh -i key -o StrictHostKeyChecking=no ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_SERVER_IP }} << 'EOF'
            chown -R ${{ env.USER_FOLDER_OWNER }}:www-data ${{ env.DEPLOY_PATH }}
            cd ${{ env.DEPLOY_PATH }} || exit 1
            su ${{ env.USER_FOLDER_OWNER }}
            git config --global --add safe.directory ${{ env.DEPLOY_PATH }}
            git pull
            chown -R ${{ env.USER_FOLDER_OWNER }}:www-data storage bootstrap/cache
            chgrp -R www-data storage bootstrap/cache
            chmod -R ug+rwx storage bootstrap/cache
            cp ${{ env.ENV_LOCATION }} .env
            composer update --ignore-platform-req=ext-bcmath
            export BUN_INSTALL="$HOME/.bun"
            export PATH="$BUN_INSTALL/bin:$PATH"
            if [ ! -f /swapfile ]; then
              dd if=/dev/zero of=/swapfile bs=1M count=3072
              chmod 600 /swapfile
              mkswap /swapfile
              swapon /swapfile
            fi
            bun update
            bun run resources/ts/plugins/iconify/build-icons.ts
            bun run build > ~/bun_log 2>&1
            php artisan down
            php artisan migrate > ~/laravel_log 2>&1
            php artisan config:cache
            php artisan up
          EOF

      - name: Cleanup temporary files
        if: always()
        run: |
          rm key
